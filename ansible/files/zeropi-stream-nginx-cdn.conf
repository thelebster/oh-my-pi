proxy_cache_path /tmp/hls-cache levels=1:2 keys_zone=hls:10m max_size=512m inactive=60s;

server {
    listen 80;
    server_name _;

    # Strip upstream CORS headers to avoid duplicates (MediaMTX adds its own)
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;

    # HLS video segments (.ts/.mp4) — immutable once created, cache aggressively
    location ~ /stream/.*\.(ts|mp4)$ {
        proxy_pass http://127.0.0.1:8888;
        proxy_cache hls;
        proxy_cache_valid 200 60s;
        proxy_cache_use_stale error timeout updating;
        proxy_cache_lock on;

        add_header X-Cache-Status $upstream_cache_status;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "public, max-age=10, s-maxage=60";
    }

    # HLS playlist (.m3u8) — must be fresh every request for live streaming
    location ~ /stream/.*\.m3u8$ {
        proxy_pass http://127.0.0.1:8888;
        proxy_cache off;

        add_header X-Cache-Status $upstream_cache_status;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-store";
    }

    # Everything else under /stream/ (e.g. WebRTC/API calls)
    location /stream/ {
        proxy_pass http://127.0.0.1:8888/stream/;

        add_header Access-Control-Allow-Origin *;
    }

    # Player page and static assets (hls.js)
    location / {
        root /var/www/stream;
        try_files $uri /index.html =404;
    }
}
