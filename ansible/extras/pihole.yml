---
- name: Deploy Pi-hole DNS server
  hosts: mypi
  become: true

  tasks:
    - name: Create Pi-hole directory
      file:
        path: /opt/pihole
        state: directory
        mode: "0755"

    - name: Copy docker-compose file
      copy:
        src: ../../pihole/docker-compose.yml
        dest: /opt/pihole/docker-compose.yml
      register: compose_file

    - name: Deploy Pi-hole env file
      copy:
        content: |
          PIHOLE_TZ={{ lookup('env', 'PIHOLE_TZ') | default('UTC', true) }}
        dest: /opt/pihole/.env
        mode: "0600"
      register: env_file

    - name: Stop systemd-resolved (frees port 53)
      systemd:
        name: systemd-resolved
        state: stopped
        enabled: false
      failed_when: false

    - name: Start Pi-hole with docker compose
      community.docker.docker_compose_v2:
        project_src: /opt/pihole
        state: present
        pull: missing
      register: pihole_result

    - name: Restart Pi-hole if config changed
      community.docker.docker_compose_v2:
        project_src: /opt/pihole
        state: restarted
      when: env_file.changed and not pihole_result.changed

    - name: Check if UFW is active
      command: ufw status
      register: ufw_status
      changed_when: false

    - name: Allow DNS (port 53) through UFW
      ufw:
        rule: allow
        port: "53"
      when: "'Status: active' in ufw_status.stdout"

    - name: Wait for Pi-hole config to be ready
      shell: docker exec pihole test -f /etc/pihole/pihole.toml
      retries: 10
      delay: 3
      register: config_ready
      until: config_ready.rc == 0
      changed_when: false

    - name: Configure upstream DNS servers (Google + Cloudflare)
      shell: |
        docker exec pihole sh -c '
          if grep -q "1.1.1.1" /etc/pihole/pihole.toml && grep -q "1.0.0.1" /etc/pihole/pihole.toml; then
            exit 0
          fi
          sed -i "/^  upstreams = \[/,/^  \]/c\  upstreams = [\n    \"8.8.8.8\",\n    \"8.8.4.4\",\n    \"1.1.1.1\",\n    \"1.0.0.1\"\n  ]" /etc/pihole/pihole.toml
          echo CHANGED
        '
      register: upstream_result
      changed_when: "'CHANGED' in upstream_result.stdout"

    - name: Enable DNSSEC validation
      shell: |
        docker exec pihole sh -c '
          if grep -q "dnssec = true" /etc/pihole/pihole.toml; then
            exit 0
          fi
          sed -i "s/dnssec = false/dnssec = true/" /etc/pihole/pihole.toml
          echo CHANGED
        '
      register: dnssec_result
      changed_when: "'CHANGED' in dnssec_result.stdout"

    - name: Reload Pi-hole DNS config
      shell: docker exec pihole pihole reloaddns
      when: upstream_result.changed or dnssec_result.changed

    - name: Set Pi-hole admin password
      shell: docker exec pihole pihole setpassword '{{ lookup("env", "PIHOLE_PASSWORD") }}'
      when: lookup("env", "PIHOLE_PASSWORD") != ""
      changed_when: false
      no_log: true

    - name: Show Pi-hole status
      debug:
        msg: |
          Pi-hole is running!
          Admin UI: http://{{ ansible_facts['default_ipv4']['address'] }}:8080/admin
          {{ 'Password: set via PIHOLE_PASSWORD' if lookup('env', 'PIHOLE_PASSWORD') != '' else 'Password: use "docker exec pihole pihole setpassword" on the Pi' }}
