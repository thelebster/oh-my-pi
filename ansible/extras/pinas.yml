---
- name: Setup PiNAS OpenMediaVault
  hosts: pinas
  become: true

  tasks:
    # === SMB FIREWALL ===
    - name: Allow SMB through firewall
      ufw:
        rule: allow
        port: "445"
      tags: smb

    # === NETWORK PROTECTION ===
    # OMV removes NetworkManager and replaces it with systemd-networkd + netplan.
    # If pinas-networkd was already run, NM is gone and this section is a no-op.
    # Otherwise, extract WiFi creds from existing netplan, write wpa_supplicant.conf
    # (for the OMV install script to parse), and create fallback netplan files with
    # names OMV won't touch.

    - name: Check if NetworkManager is installed
      shell: dpkg -l network-manager 2>/dev/null | grep -q '^ii'
      register: nm_installed
      changed_when: false
      failed_when: false
      check_mode: false
      tags: omv

    - name: Read WiFi SSID from netplan config
      shell: grep -rh -A1 'access-points:' /etc/netplan/ 2>/dev/null | grep -v access-points | grep -v -- '--' | awk -F'"' '{print $2}' | head -1
      register: wifi_ssid
      changed_when: false
      failed_when: false
      when: nm_installed.rc == 0
      tags: omv

    - name: Read WiFi password from netplan config
      shell: grep -rh 'password:' /etc/netplan/ 2>/dev/null | awk -F'"' '{print $2}' | head -1
      register: wifi_psk
      changed_when: false
      failed_when: false
      when: nm_installed.rc == 0
      tags: omv

    - name: Show detected WiFi network
      debug:
        msg: "WiFi: {{ wifi_ssid.stdout | default('not detected') }}"
      when: nm_installed.rc == 0
      tags: omv

    - name: Write wpa_supplicant.conf for OMV install script
      copy:
        dest: /etc/wpa_supplicant/wpa_supplicant.conf
        content: |
          ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
          update_config=1
          network={
            ssid="{{ wifi_ssid.stdout }}"
            psk="{{ wifi_psk.stdout }}"
          }
        mode: "0600"
      when: nm_installed.rc == 0 and wifi_ssid.stdout | default('') | length > 0
      tags: omv

    - name: Create ethernet fallback netplan config
      copy:
        dest: /etc/netplan/99-ethernet-fallback.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              end0:
                optional: true
                dhcp4: true
        mode: "0600"
      when: nm_installed.rc == 0
      tags: omv

    - name: Create WiFi fallback netplan config
      copy:
        dest: /etc/netplan/99-wifi-fallback.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            wifis:
              wlan0:
                optional: true
                dhcp4: true
                access-points:
                  "{{ wifi_ssid.stdout }}":
                    password: "{{ wifi_psk.stdout }}"
        mode: "0600"
      when: nm_installed.rc == 0 and wifi_ssid.stdout | default('') | length > 0
      tags: omv

    # === OPENMEDIAVAULT ===
    - name: Install OpenMediaVault dependencies
      apt:
        name: [gnupg, wget]
        state: present
      tags: omv

    - name: Install OpenMediaVault (skip reboot)
      shell: |
        wget -qO /tmp/omv-install https://github.com/OpenMediaVault-Plugin-Developers/installScript/raw/master/install
        chmod +x /tmp/omv-install
        /tmp/omv-install -r
      args:
        creates: /usr/sbin/omv-firstaid
      async: 2400
      poll: 30
      register: omv_install
      tags: omv

    - name: Unblock WiFi after OMV install
      command: rfkill unblock all
      changed_when: false
      failed_when: false
      tags: omv

    # OMV install script registers eth0 in its database, but after it removes
    # NetworkManager the interface becomes end0 (predictable name). Fix this.
    - name: Fix ethernet interface name in OMV config (eth0 â†’ end0)
      replace:
        path: /etc/openmediavault/config.xml
        regexp: '<devicename>eth0</devicename>'
        replace: '<devicename>end0</devicename>'
      register: omv_iface_fix
      tags: omv

    - name: Deploy OMV network config after interface fix
      command: omv-salt deploy run systemd-networkd
      when: omv_iface_fix is changed
      tags: omv

    - name: Install OMV plugins
      apt:
        name:
          - openmediavault-md
          - openmediavault-cputemp
          - openmediavault-diskstats
        state: present
      tags: omv

    - name: Install omv-extras repo
      shell: wget -qO- https://github.com/OpenMediaVault-Plugin-Developers/packages/raw/master/install | bash
      args:
        creates: /usr/share/openmediavault/mkconf/omvextras
      tags: [omv, omv-extras]

    - name: Reboot after OMV install
      reboot:
        reboot_timeout: 300
      when: omv_install is changed
      tags: omv

