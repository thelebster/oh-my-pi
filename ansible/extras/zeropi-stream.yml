---
- name: Setup MediaMTX Camera Streaming
  hosts: zeropi
  become: true

  vars:
    mediamtx_version: "1.15.6"

  tasks:
    # === INSTALL ===
    - name: Set architecture for download (arm64 or armv7)
      set_fact:
        mediamtx_arch: "{{ 'arm64' if ansible_facts['architecture'] == 'aarch64' else 'armv7' }}"
      tags: install

    - name: Check current mediamtx version
      command: mediamtx --version
      register: mediamtx_current
      changed_when: false
      failed_when: false
      tags: install

    - name: Download MediaMTX tarball
      get_url:
        url: "https://github.com/bluenviron/mediamtx/releases/download/v{{ mediamtx_version }}/mediamtx_v{{ mediamtx_version }}_linux_{{ mediamtx_arch }}.tar.gz"
        dest: "/tmp/mediamtx.tar.gz"
      when: mediamtx_current.rc != 0 or mediamtx_version not in (mediamtx_current.stdout | default(''))
      tags: install

    - name: Extract mediamtx binary
      unarchive:
        src: /tmp/mediamtx.tar.gz
        dest: /usr/local/bin
        remote_src: true
        include: mediamtx
        mode: "0755"
      when: mediamtx_current.rc != 0 or mediamtx_version not in (mediamtx_current.stdout | default(''))
      notify: Restart mediamtx
      tags: install

    # === CONFIGURE ===
    - name: Create config directory
      file:
        path: /etc/mediamtx
        state: directory
        mode: "0755"
      tags: config

    - name: Deploy MediaMTX config
      copy:
        src: ../files/mediamtx.yml
        dest: /etc/mediamtx/mediamtx.yml
        mode: "0644"
      notify: Restart mediamtx
      tags: config

    # === SERVICE ===
    - name: Deploy systemd unit
      copy:
        src: ../files/mediamtx.service
        dest: /etc/systemd/system/mediamtx.service
        mode: "0644"
      notify:
        - Reload systemd
        - Restart mediamtx
      tags: service

    - name: Enable and start mediamtx
      systemd:
        name: mediamtx
        state: started
        enabled: true
      tags: service

    # === NGINX CACHE ===
    - name: Install nginx
      apt:
        name: nginx
        state: present
      tags: nginx

    - name: Deploy nginx stream cache config
      copy:
        src: ../files/zeropi-stream-nginx.conf
        dest: /etc/nginx/sites-available/stream.conf
        mode: "0644"
      notify: Reload nginx
      tags: nginx

    - name: Enable stream site
      file:
        src: /etc/nginx/sites-available/stream.conf
        dest: /etc/nginx/sites-enabled/stream.conf
        state: link
      notify: Reload nginx
      tags: nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx
      tags: nginx

    - name: Enable and start nginx
      systemd:
        name: nginx
        enabled: true
        state: started
      tags: nginx

    # === FIREWALL ===
    - name: Check if UFW is active
      command: ufw status
      register: ufw_status
      changed_when: false
      tags: firewall

    - name: Open streaming ports (RTSP, HLS, WebRTC)
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: "8554", proto: tcp }
        - { port: "8888", proto: tcp }
        - { port: "8889", proto: tcp }
        - { port: "8189", proto: udp }
      when: "'Status: active' in ufw_status.stdout"
      tags: firewall

    # === VERIFY ===
    - name: Check nginx service status
      command: systemctl is-active nginx
      register: nginx_status
      changed_when: false
      failed_when: false
      tags: [verify, status]

    - name: Check mediamtx service status
      command: systemctl is-active mediamtx
      register: service_status
      changed_when: false
      failed_when: false
      tags: [verify, status]

    - name: Get mediamtx version
      command: mediamtx --version
      register: version_output
      changed_when: false
      failed_when: false
      tags: [verify, status]

    - name: Show summary
      debug:
        msg: |
          ========== MEDIAMTX STREAMING ==========

          MEDIAMTX: {{ service_status.stdout | default('unknown') }}
          VERSION:  {{ version_output.stdout | default('unknown') }}
          NGINX:    {{ nginx_status.stdout | default('unknown') }}

          STREAM URLs (local):
            RTSP:   rtsp://zeropi.local:8554/stream  (VLC, Home Assistant)
            HLS:    http://zeropi.local:8888/stream   (direct, no cache)
            WebRTC: http://zeropi.local:8889/stream   (browser, low latency)

          CACHED (via nginx):
            HLS:    http://zeropi.local/stream/       (cached, use for public)

          COMMANDS:
            journalctl -u mediamtx -f              # follow logs
            journalctl -u nginx -f                 # nginx logs
      tags: [verify, status]

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Restart mediamtx
      systemd:
        name: mediamtx
        state: restarted

    - name: Reload nginx
      systemd:
        name: nginx
        state: reloaded
